var nepal=function(){"use strict";function e(e,t,n,r,i){var s,o;s=d3.select(t);o=s.append("g").attr("class","nj-"+n+"-title");o.append("text").attr("class","nj-svg-title").attr("x",r/2).attr("y",15).text(e)}function t(e,t,n,r,i,s,o,u){var a,f,l;a=d3.select(t);l=d3.max(d3.values(o));f=a.append("g").attr("class","nj-"+n+"-legend");var c,h,p;if(!u)u="bottom-left";if(u==="top-left"){c=10;h=5;p=(l+1)*28-10}else if(u==="top-right"){c=r-120;h=5;p=(l+1)*28-10}else if(u==="bottom-left"){c=10;h=i-(l+1)*28;p=i-h-5}else if(u==="bottom-right"){c=r-120;h=i-(l+1)*28;p=i-h-5}d3.select("body").append("span").attr("id","nj-fake-span").style("display","none").text(e);var d=$("#nj-fake-span").width();d=d>115?d+7:115;f.append("rect").attr("class","nj-legend-box").attr("x",c).attr("y",h).attr("width",d).attr("height",p);f.selectAll("g").data(o).enter().append("g").each(function(t,n){var o=d3.select(this),a,c,h,p,d,v;if(u==="top-left"){a=15;c=(l-n+2)*20-10;h=40;p=(l-n+2)*20;d=15;v=20}else if(u==="top-right"){a=r-115;c=(l-n+2)*20-10;h=r-90;p=(l-n+2)*20;d=r-115;v=20}else if(u==="bottom-left"){a=15;c=i-(n+1)*20-10;h=40;p=i-(n+1)*20;d=15;v=i-(l+2)*20}else if(u==="bottom-right"){a=r-115;c=i-(n+1)*20-10;h=r-90;p=i-(n+1)*20;d=r-115;v=i-(l+2)*20}o.append("rect").attr("class","nj-legend-rect q"+t+"-"+(l+1)).attr("x",a).attr("y",c).attr("width",15).attr("height",15);o.append("text").attr("class","nj-legend-text").attr("x",h).attr("y",p).attr("height",15).attr("width",100).text(n===0?"< "+Math.round(s[n]):n===l?Math.round(s[n-1])+" + ":Math.round(s[n-1])+" - "+Math.round(s[n]));if(n===l){f.append("text").attr("class","nj-legend-title").attr("x",d).attr("y",v).text(e)}})}function n(e,t,n,r,i,s,o){var u=d3.select(t);var a=u.append("g").attr("class","nj-"+n+"-legend");var f=d3.scale.quantile().domain(s.domain()).range(d3.range(5));var l=d3.max(d3.values(s.range()));if(!o)o="bottom-left";a.selectAll("g").data(f.quantiles()).enter().append("g").each(function(t,n){var u=d3.select(this);var a,c,h,p;if(o=="top-right"){a=r-l-20;c=2*l+20;h=a;p=20}else if(o=="top-left"){a=l+20;c=2*l+20;h=a;p=20}else if(o=="bottom-left"){a=l+15;c=i-15;h=a;p=i-2*l-15}else if(o=="bottom-right"){a=r-l-15;c=i-15;h=a;p=i-2*l-15}u.append("circle").attr("transform","translate("+a+","+c+")").attr("class","nj-legend-circle").attr("cy",function(e){return-s(e)}).attr("r",s);u.append("text").attr("transform","translate("+a+","+c+")").attr("class","nj-legend-circle-text").attr("y",function(e){return-2*s(e)}).attr("dy","0.8em").text(d3.format(".1s"));if(t==d3.max(d3.values(f.quantiles()))){u.append("text").attr("class","nj-legend-title").style("text-anchor","middle").attr("x",h).attr("y",p).text(e)}})}var r=function(r){var i=r.svgId,s=r.nepalTopojson,o=r.data,u=r.admLevel,a=r.subdivisionIds,f=r.map,l=r.title,c=r.showToolbar;var h=$(i).parent().width(),p=$(i).parent().height();var d=d3.select(i).attr("width",h).attr("height",p).attr("viewBox","0 0 "+h+" "+p).attr("preserveAspectRatio","xMinXyMinY meet");var v=d3.geo.mercator();var m=d3.geo.path().projection(v);var g=2*Math.PI,y=0,b=1443154,w=d3.format(".0%");var E=d3.svg.arc().startAngle(0).innerRadius(18).outerRadius(24);var S=d.append("g").attr("class","nj-map-progress-meter").attr("transform","translate("+h/2+","+p/2+")");S.append("path").attr("class","background").attr("d",E.endAngle(g));var x=S.append("path").attr("class","foreground");var T=S.append("text").attr("text-anchor","middle").attr("dy",".15em");d3.json(s).on("progress",function(){var e=d3.interpolate(y,d3.event.loaded/b);d3.transition().tween("progress",function(){return function(t){y=e(t);x.attr("d",E.endAngle(g*y));T.text(w(y))}})}).get(function(r,s){function P(){d.append("foreignObject").attr("width",30).attr("height",110).attr("class","nj-foreign-object").append("xhtml:div").style("padding","4px").html('<input type="button"/ class="nj-nav-button" id="nj-nav-button-plus" value="+" title="zoom in"><br/>'+'<input type="button"/ class="nj-nav-button" id="nj-nav-button-home" value="&#8632" title="reset"><br/>'+'<input type="button"/ class="nj-nav-button" id="nj-nav-button-minus" value="-" title="zoom out"><br />'+'<input type="button"/ class="nj-nav-button" id="nj-nav-button-download" value="&#10515;" title="download">');var e=d3.select(i).select(".nj-foreign-object").select("div");var t=1;e.select("#nj-nav-button-plus").on("click",function(){if(t<=12){d3.select(i).select(".nj-"+u+"-container").selectAll("path").transition().duration(500).attr("transform","translate("+h/2+","+p/2+")scale("+ ++t+")translate("+ -h/2+","+ -p/2+")").style("stroke-width",.25/t);d3.select(i).select(".nj-"+u+"-boundary").selectAll("path").transition().duration(500).attr("transform","translate("+h/2+","+p/2+")scale("+t+")translate("+ -h/2+","+ -p/2+")").style("stroke-width",1/t);d3.select(i).select(".nj-"+u+"-bubble-container").selectAll("circle").transition().duration(500).attr("transform",function(){return"translate("+h/2+","+p/2+")scale("+t+")translate("+ -h/2+","+ -p/2+")"}).attr("r",function(e){return D(O[e.id])/t}).attr("stroke-width",.5/t)}});e.select("#nj-nav-button-minus").on("click",function(){if(t>1){d3.select(i).select(".nj-"+u+"-container").selectAll("path").transition().duration(500).attr("transform","translate("+h/2+","+p/2+")scale("+ --t+")translate("+ -h/2+","+ -p/2+")").style("stroke-width",.25/t);d3.select(i).select(".nj-"+u+"-boundary").selectAll("path").transition().duration(500).attr("transform","translate("+h/2+","+p/2+")scale("+t+")translate("+ -h/2+","+ -p/2+")").style("stroke-width",1/t);d3.select(i).select(".nj-"+u+"-bubble-container").selectAll("circle").transition().duration(500).attr("transform",function(){return"translate("+h/2+","+p/2+")scale("+t+")translate("+ -h/2+","+ -p/2+")"}).attr("r",function(e){return D(O[e.id])/t}).attr("stroke-width",.5/t)}});e.select("#nj-nav-button-home").on("click",function(){t=1;d3.select(i).select(".nj-"+u+"-container").selectAll("path").transition().duration(500).attr("transform","translate("+0+","+0+")scale("+1+")").style("stroke-width",.25/t);d3.select(i).select(".nj-"+u+"-boundary").selectAll("path").transition().duration(500).attr("transform","translate("+0+","+0+")scale("+1+")").style("stroke-width",1);d3.select(i).select(".nj-"+u+"-container").transition().duration(500).attr("transform","translate("+0+","+0+")");d3.select(i).select(".nj-"+u+"-boundary").transition().duration(500).attr("transform","translate("+0+","+0+")");d3.select(i).select(".nj-"+u+"-bubble-container").selectAll("circle").transition().duration(500).attr("transform","translate("+0+","+0+")scale("+1+")").attr("r",function(e){return D(O[e.id])}).attr("stroke-width",.5);d3.select(i).select(".nj-"+u+"-bubble-container").transition().duration(500).attr("transform","translate("+0+","+0+")")});e.select("#nj-nav-button-download").on("click",function(){$(i+" > .nj-download-option").remove();d.append("foreignObject").attr("width",h).attr("height",p).attr("class","nj-foreign-object-download").append("xhtml:div").attr("class","nj-download-option").style("margin-top",p/2-100+"px").style("margin-left",h/2-100+"px").html("<table>"+'<tr><td><b>Name:</b></td><td><input type="text" size="10" id="'+i.replace(/^#/,"")+'-name" /></td></tr>'+'<tr><td><b>Scale:</b></td><td><input type="text"size="10" id="'+i.replace(/^#/,"")+'-scale" /></td></tr>'+"</table>"+'<input type="button" id="'+i.replace(/^#/,"")+'-download" value="Download" />'+'<input type="button" id="'+i.replace(/^#/,"")+'-close" value="Close" />');$(i+"-download").click(function(e){e.preventDefault();var t=$(i+"-name").val(),n=$(i+"-scale").val();saveSvgAsPng(document.getElementById(i.replace(/^#/,"")),t.trim()+".png",n.trim());$(i+" > .nj-foreign-object-download").remove()});$(i+"-close").click(function(e){e.preventDefault();$(i+" > .nj-foreign-object-download").remove()})})}if(r)return console.error(r);d3.select(".nj-map-progress-meter").remove();var g,y;switch(u){case"devregion":g=topojson.feature(s,s.objects.regions);break;case"zone":if(!a){g=topojson.feature(s,s.objects.zones);y=topojson.mesh(s,s.objects.regions,function(e,t){return e!==t})}else{g=topojson.feature(s,{type:"GeometryCollection",geometries:s.objects.zones.geometries.filter(function(e){return a.indexOf(e.id.substring(0,1))>-1})});y=topojson.mesh(s,{type:"GeometryCollection",geometries:s.objects.regions.geometries.filter(function(e){return a.indexOf(e.id)>-1})},function(e,t){return e!==t})}break;case"district":if(!a){g=topojson.feature(s,s.objects.districts)}else{g=topojson.feature(s,{type:"GeometryCollection",geometries:s.objects.districts.geometries.filter(function(e){return a.indexOf(e.id.substring(0,3))>-1})});y=topojson.mesh(s,s.objects.zones,function(e,t){return e!==t});y=topojson.mesh(s,{type:"GeometryCollection",geometries:s.objects.zones.geometries.filter(function(e){return a.indexOf(e.id)>-1})},function(e,t){return e!==t})}break;case"vdc":if(!a){g=topojson.feature(s,s.objects.vdcs);y=topojson.mesh(s,s.objects.districts,function(e,t){return e!==t})}else{g=topojson.feature(s,{type:"GeometryCollection",geometries:s.objects.vdcs.geometries.filter(function(e){return a.indexOf(e.id.substring(0,5))>-1})});y=topojson.mesh(s,{type:"GeometryCollection",geometries:s.objects.districts.geometries.filter(function(e){return a.indexOf(e.id)>-1})},function(e,t){return e!==t})}break;default:if(!a){console.log("Valid Administrative Level Types: devregion, zone, district, and vdc.")}else{console.log("Valid Administrative Level Types: zone, district, and vdc.")}break}v.scale(1).translate([0,0]);var b=m.bounds(g),w=.95/Math.max((b[1][0]-b[0][0])/h,(b[1][1]-b[0][1])/p),E=[(h-w*(b[1][0]+b[0][0]))/2,(p-w*(b[1][1]+b[0][1]))/2];v.scale(w).translate(E);var S=[0,0];var x=d3.behavior.drag().origin(function(){return{x:S[0],y:S[1]}}).on("drag",function(){S=[d3.event.x,d3.event.y];d3.select(i).select(".nj-"+u+"-container").attr("transform","translate("+S+")");d3.select(i).select(".nj-"+u+"-boundary").attr("transform","translate("+S+")");d3.select(i).select(".nj-"+u+"-bubble-container").attr("transform","translate("+S+")")});d.call(x);var T=d.append("g").attr("class","nj-"+u+"-container").selectAll(".nj-"+u).data(g.features).enter().append("path").attr("id",function(e){return u+"-"+e.id}).attr("d",m).style("stroke","#fff").style("stroke-width","0.25px");d.append("g").attr("class","nj-"+u+"-boundary").append("path").datum(y).attr("d",m).style("stroke-width","1px");var N=f.type,C=f.range,k=f.showTooltip,L=f.legendTitle,A=f.legendPosition;var O={},M,_,D;d3.json(o,function(e,r){if(e)return console.error(e);r.forEach(function(e){O[e.id]=+e.value});_=d3.max(d3.values(O));M=d3.min(d3.values(O));switch(N){case"choropleth":var s=f.quantitativeScaleType,o=f.colorScheme,a;switch(s){case"quantile":a=d3.scale.quantile().domain([M,_]).range(d3.range(C));d3.select(i).attr("class",o);d3.select(i).select(".nj-"+u+"-container").selectAll("path").attr("class",function(e){return"nj-"+u+" q"+a(O[e.id])+"-"+C});t(L,i,u,h,p,a.quantiles(),a.range(),A);break;default:console.log("Supported quantitative scale: quantile");break}if(k){d3.select(i).select(".nj-"+u+"-container").selectAll("path").on("mouseover",function(e){d3.select(this).style("fill","red");d3.select("body").append("div").attr("class","nj-tooltip").style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-40+"px").html(e.properties.name+"<br //><b>"+O[e.id]+"<//b>")}).on("mouseout",function(e){d3.select(this).style("fill",null);d3.selectAll(".nj-tooltip").remove()})}if(c){P()}break;case"bubble":D=d3.scale.sqrt().domain([M,_]).range(C);d.append("g").attr("class","nj-"+u+"-bubble-container").selectAll("circle").data(g.features.sort(function(e,t){return O[t.id]-O[e.id]})).enter().append("circle").attr("class","nj-"+u+"-bubble").attr("cx",function(e){return m.centroid(e)[0]}).attr("cy",function(e){return m.centroid(e)[1]}).attr("r",function(e){return D(O[e.id])}).attr("stroke-width",.5);n(L,i,u,h,p,D,A);if(k){d3.select(i).select(".nj-"+u+"-bubble-container").selectAll("circle").on("mouseover",function(e){d3.select("body").append("div").attr("class","nj-tooltip").style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY-40+"px").html(e.properties.name+"<br //><b>"+O[e.id]+"<//b>")}).on("mouseout",function(e){d3.selectAll(".nj-tooltip").remove()})}if(c){P()}break;default:console.log("Supported Maps: Choropleth");break}});$(window).on("resize",function(){var e=$(i).parent().width();var t=$(i).parent().height();d3.select(i).attr("width",e).attr("height",t)});if(l){e(l,i,u,h,p)}})};return{createMap:r}}()